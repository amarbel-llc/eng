#! /usr/bin/env -S bash -e

if [[ $# -gt 0 ]]; then
  git add "$@"
fi

diff_status=$(git diff --cached 2>&1)

if [[ -z $diff_status ]]; then
  echo "no changes, just pushing" >&2
else
  msg_claude_prompt="$(
    cat - <<-EOM
    output text that will be used for a git commit message that summarizes the
    current staged changes.
    include no other output, as it will be piped directly into the git commit message
EOM
  )"

  if ! commit_msg="$(gum spin --spinner monkey --title "generating commit message..." -- \
    claude -p "$msg_claude_prompt")"; then
    gum log -t error claude commit message generation failed
    exit 1
  fi

  if ! echo -n "$commit_msg" | git commit -e -F -; then
    gum log -t error git commit failed
    exit 1
  fi
fi

echo "pushing..." >&2
git sync
